<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VidStream</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0a0a0a;--bg2:#1a1a1a;--text:#fff;--text2:#888;--accent:#ff3b30}
    [data-theme="light"]{--bg:#f5f5f5;--bg2:#fff;--text:#111;--text2:#666}
    [data-accent="blue"]{--accent:#007aff}
    [data-accent="purple"]{--accent:#af52de}
    [data-accent="green"]{--accent:#34c759}
    [data-accent="orange"]{--accent:#ff9500}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
    .header{position:fixed;top:0;left:0;right:0;height:56px;background:var(--bg);border-bottom:1px solid rgba(128,128,128,0.2);display:flex;align-items:center;padding:0 12px;z-index:1000;gap:8px}
    .logo{display:flex;align-items:center;gap:6px;cursor:pointer}
    .logo-text{font-size:16px;font-weight:700}
    .search-form{flex:1;display:flex}
    .search-input{flex:1;height:36px;background:var(--bg2);border:1px solid rgba(128,128,128,0.2);border-radius:18px 0 0 18px;padding:0 14px;font-size:13px;color:var(--text);font-family:inherit}
    .search-input:focus{outline:none;border-color:var(--accent)}
    .search-btn{height:36px;padding:0 12px;background:var(--bg2);border:1px solid rgba(128,128,128,0.2);border-left:none;border-radius:0 18px 18px 0;color:var(--text2);cursor:pointer}
    .header-btn{width:36px;height:36px;background:none;border:none;color:var(--text);cursor:pointer;border-radius:50%;font-size:18px}
    
    .main{padding:56px 0 70px}
    .tabs{display:flex;gap:4px;padding:8px 12px;overflow-x:auto;background:var(--bg);position:sticky;top:56px;z-index:99}
    .tab{padding:8px 14px;border:none;border-radius:8px;font-size:12px;font-family:inherit;cursor:pointer;white-space:nowrap;background:var(--bg2);color:var(--text2)}
    .tab.active{background:var(--accent);color:#fff;font-weight:600}
    
    .section-title{font-size:14px;font-weight:600;padding:12px;display:flex;align-items:center;justify-content:space-between}
    .clear-btn{font-size:11px;color:var(--accent);background:none;border:none;cursor:pointer}
    
    .for-you{padding:8px 12px;background:linear-gradient(90deg,var(--accent),#ff6b6b);margin:8px 12px;border-radius:10px;color:#fff;font-size:12px}
    
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:0 12px}
    .card{cursor:pointer;position:relative}
    .thumb-wrap{position:relative;border-radius:10px;overflow:hidden;aspect-ratio:16/9;background:var(--bg2)}
    .thumb{width:100%;height:100%;object-fit:cover}
    .dur{position:absolute;bottom:6px;right:6px;background:rgba(0,0,0,0.8);padding:2px 5px;border-radius:3px;font-size:10px;font-weight:600}
    .card-actions{position:absolute;top:6px;right:6px;display:flex;gap:4px}
    .card-action{width:26px;height:26px;background:rgba(0,0,0,0.7);border:none;border-radius:50%;color:#fff;cursor:pointer;font-size:11px}
    .card-action.active{color:var(--accent)}
    .info{display:flex;gap:8px;padding:6px 0}
    .avatar{width:28px;height:28px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;flex-shrink:0}
    .avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover}
    .meta{flex:1;min-width:0}
    .title{font-size:12px;font-weight:500;line-height:1.3;margin-bottom:2px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .channel{font-size:10px;color:var(--text2)}
    .stats{font-size:10px;color:var(--text2)}
    
    .loader{text-align:center;padding:20px;color:var(--text2);font-size:13px;display:none}
    .loader.active{display:block}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spinner{display:inline-block;width:18px;height:18px;border:2px solid var(--bg2);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}
    
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;height:56px;background:var(--bg);border-top:1px solid rgba(128,128,128,0.2);display:flex;z-index:1000}
    .nav-item{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;color:var(--text2);cursor:pointer;font-size:10px;border:none;background:none}
    .nav-item.active{color:var(--accent)}
    .nav-icon{font-size:20px}
    
    .modal{position:fixed;inset:0;background:var(--bg);z-index:2000;display:none;flex-direction:column}
    .modal.active{display:flex}
    .modal-header{display:flex;align-items:center;gap:12px;padding:10px 12px;background:var(--bg)}
    .modal-back{background:none;border:none;color:var(--text);cursor:pointer;font-size:20px;padding:4px}
    .modal-title{font-size:13px;font-weight:600;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .player-wrap{aspect-ratio:16/9;background:#000;position:relative;flex-shrink:0}
    #ytplayer{width:100%;height:100%;position:absolute;top:0;left:0}
    .player-controls{display:flex;align-items:center;justify-content:center;gap:10px;padding:10px;background:var(--bg2)}
    .p-btn{width:36px;height:36px;background:rgba(128,128,128,0.2);border:none;border-radius:50%;color:var(--text);cursor:pointer;font-size:14px}
    .p-btn.active{color:var(--accent);background:rgba(255,59,48,0.2)}
    .speed-btn{width:auto;padding:0 10px;border-radius:18px;font-size:11px;font-family:inherit}
    .player-info{padding:12px;flex:1;overflow-y:auto}
    .player-title{font-size:14px;font-weight:600;margin-bottom:8px;line-height:1.4}
    .player-meta{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .player-avatar{width:32px;height:32px;border-radius:50%}
    .player-channel{font-size:12px;font-weight:500}
    .player-stats{font-size:11px;color:var(--text2)}
    .player-btns{display:flex;gap:6px;flex-wrap:wrap}
    .pl-btn{padding:8px 12px;background:var(--bg2);border:none;border-radius:16px;color:var(--text);font-family:inherit;font-size:11px;cursor:pointer;display:flex;align-items:center;gap:4px}
    .pl-btn.active{background:var(--accent);color:#fff}
    .up-next{margin-top:12px;padding-top:12px;border-top:1px solid rgba(128,128,128,0.2)}
    .up-next-label{font-size:11px;color:var(--text2);margin-bottom:8px}
    .up-next-card{display:flex;gap:10px;cursor:pointer}
    .up-next-thumb{width:100px;aspect-ratio:16/9;border-radius:6px;object-fit:cover}
    .up-next-title{font-size:11px;font-weight:500;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .up-next-channel{font-size:10px;color:var(--text2)}
    
    .mini-player{position:fixed;bottom:60px;left:8px;right:8px;background:var(--bg2);border-radius:10px;display:none;align-items:center;gap:8px;padding:6px;z-index:999;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
    .mini-player.active{display:flex}
    .mini-thumb{width:50px;aspect-ratio:16/9;border-radius:6px;object-fit:cover}
    .mini-info{flex:1;min-width:0}
    .mini-title{font-size:11px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .mini-btns{display:flex;gap:2px}
    .mini-btn{width:30px;height:30px;background:none;border:none;color:var(--text);cursor:pointer;font-size:14px}
    
    .shorts-viewer{position:fixed;inset:0;background:#000;z-index:2000;display:none;flex-direction:column}
    .shorts-viewer.active{display:flex}
    .shorts-header{position:absolute;top:0;left:0;right:0;padding:12px;display:flex;justify-content:space-between;z-index:10;background:linear-gradient(to bottom,rgba(0,0,0,0.7),transparent)}
    .shorts-close{background:none;border:none;color:#fff;font-size:24px;cursor:pointer}
    .shorts-container{flex:1;overflow-y:scroll;scroll-snap-type:y mandatory;-webkit-overflow-scrolling:touch}
    .shorts-container::-webkit-scrollbar{display:none}
    .short-item{height:100vh;height:100dvh;scroll-snap-align:start;position:relative;display:flex;align-items:center;justify-content:center;background:#000}
    .short-video{width:100%;height:100%;max-width:400px;position:relative}
    .short-video iframe{width:100%;height:100%;border:none;pointer-events:none}
    .short-tap{position:absolute;inset:0;z-index:5}
    .short-overlay{position:absolute;bottom:0;left:0;right:0;padding:16px;background:linear-gradient(to top,rgba(0,0,0,0.8),transparent);color:#fff;z-index:6;pointer-events:none}
    .short-title{font-size:13px;font-weight:500;margin-bottom:6px}
    .short-channel{font-size:11px;color:#ccc}
    .short-actions{position:absolute;right:12px;bottom:80px;display:flex;flex-direction:column;gap:16px;align-items:center;z-index:6}
    .short-action{display:flex;flex-direction:column;align-items:center;gap:4px;color:#fff;background:none;border:none;cursor:pointer}
    .short-action-icon{width:40px;height:40px;background:rgba(255,255,255,0.15);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:18px}
    .short-action.active .short-action-icon{background:var(--accent)}
    .short-action span{font-size:10px}
    .short-nav{position:absolute;left:50%;bottom:20px;transform:translateX(-50%);display:flex;gap:8px;z-index:10}
    .short-nav button{width:40px;height:40px;background:rgba(255,255,255,0.2);border:none;border-radius:50%;color:#fff;font-size:16px;cursor:pointer}
    
    .settings-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:3000;display:none;align-items:flex-end}
    .settings-modal.show{display:flex}
    .settings-box{background:var(--bg2);border-radius:16px 16px 0 0;padding:20px;width:100%;max-height:70vh;overflow-y:auto}
    .settings-title{font-size:16px;font-weight:600;margin-bottom:16px}
    .setting-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid rgba(128,128,128,0.2)}
    .setting-label{font-size:13px}
    .setting-options{display:flex;gap:6px}
    .setting-opt{width:28px;height:28px;border-radius:50%;border:2px solid transparent;cursor:pointer}
    .setting-opt.active{border-color:var(--text)}
    .toggle{width:44px;height:24px;background:rgba(128,128,128,0.3);border-radius:12px;cursor:pointer;position:relative}
    .toggle.on{background:var(--accent)}
    .toggle::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;background:#fff;border-radius:50%;transition:transform 0.2s}
    .toggle.on::after{transform:translateX(20px)}
    
    .share-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:3000;display:none;align-items:center;justify-content:center;padding:20px}
    .share-modal.show{display:flex}
    .share-box{background:var(--bg2);border-radius:16px;padding:20px;width:100%;max-width:300px;text-align:center}
    .share-title{font-size:16px;font-weight:600;margin-bottom:12px}
    .share-url{font-size:10px;color:var(--text2);word-break:break-all;margin-bottom:12px}
    .copy-btn{padding:10px 20px;background:var(--accent);border:none;border-radius:20px;color:#fff;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer}
    .close-share{margin-top:10px;background:none;border:none;color:var(--text2);cursor:pointer;font-size:12px}
    
    .empty{text-align:center;padding:40px 20px;color:var(--text2);grid-column:1/-1}
    @media(min-width:600px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(min-width:900px){.grid{grid-template-columns:repeat(4,1fr)}}
  </style>
</head>
<body>
  <header class="header">
    <div class="logo" onclick="goHome()">
      <svg width="24" height="17" viewBox="0 0 28 20"><rect width="28" height="20" rx="4" fill="var(--accent)"/><path d="M11 6L18 10L11 14V6Z" fill="#fff"/></svg>
      <span class="logo-text">VidStream</span>
    </div>
    <form class="search-form" onsubmit="search(event)">
      <input type="text" class="search-input" id="q" placeholder="Search...">
      <button type="submit" class="search-btn">üîç</button>
    </form>
    <button class="header-btn" onclick="openSettings()">‚öôÔ∏è</button>
  </header>

  <main class="main" id="mainContent"></main>

  <div class="mini-player" id="miniPlayer">
    <img class="mini-thumb" id="miniThumb">
    <div class="mini-info"><div class="mini-title" id="miniTitle"></div></div>
    <div class="mini-btns">
      <button class="mini-btn" onclick="toggleMiniPlay()">‚èØÔ∏è</button>
      <button class="mini-btn" onclick="expandPlayer()">‚¨ÜÔ∏è</button>
      <button class="mini-btn" onclick="closeMini()">‚úï</button>
    </div>
  </div>

  <nav class="bottom-nav" id="bottomNav">
    <button class="nav-item active" onclick="goHome()" id="navHome"><span class="nav-icon">üè†</span>Home</button>
    <button class="nav-item" onclick="showShorts()" id="navShorts"><span class="nav-icon">üì±</span>Shorts</button>
    <button class="nav-item" onclick="showFavorites()" id="navFav"><span class="nav-icon">‚ù§Ô∏è</span>Favorites</button>
    <button class="nav-item" onclick="showWatchLater()" id="navLater"><span class="nav-icon">‚è∞</span>Later</button>
    <button class="nav-item" onclick="showHistory()" id="navHistory"><span class="nav-icon">üïê</span>History</button>
  </nav>

  <div class="modal" id="modal">
    <div class="modal-header">
      <button class="modal-back" onclick="minimizePlayer()">‚Üì</button>
      <div class="modal-title" id="modalTitle"></div>
      <button class="header-btn" onclick="closeModal()">‚úï</button>
    </div>
    <div class="player-wrap" id="playerWrap"></div>
    <div class="player-controls">
      <button class="p-btn" onclick="playPrev()">‚èÆÔ∏è</button>
      <button class="p-btn" id="shuffleBtn" onclick="toggleShuffle()">üîÄ</button>
      <button class="p-btn" id="loopBtn" onclick="toggleLoop()">üîÅ</button>
      <button class="p-btn speed-btn" id="speedBtn" onclick="cycleSpeed()">1x</button>
      <button class="p-btn" onclick="playNext()">‚è≠Ô∏è</button>
    </div>
    <div class="player-info">
      <div class="player-title" id="pTitle"></div>
      <div class="player-meta">
        <div id="pAvatarWrap"></div>
        <div><div class="player-channel" id="pChannel"></div><div class="player-stats" id="pStats"></div></div>
      </div>
      <div class="player-btns">
        <button class="pl-btn" id="favBtn" onclick="toggleFav()">ü§ç Like</button>
        <button class="pl-btn" id="laterBtn" onclick="toggleLater()">‚è∞ Later</button>
        <button class="pl-btn" onclick="shareVideo()">‚ÜóÔ∏è Share</button>
      </div>
      <div class="up-next">
        <div class="up-next-label">Up Next</div>
        <div class="up-next-card" onclick="playNext()">
          <img class="up-next-thumb" id="nextThumb">
          <div><div class="up-next-title" id="nextTitle"></div><div class="up-next-channel" id="nextChannel"></div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="shorts-viewer" id="shortsViewer">
    <div class="shorts-header">
      <button class="shorts-close" onclick="closeShorts()">‚úï</button>
      <span style="color:#fff;font-weight:600">Shorts</span>
      <div style="width:24px"></div>
    </div>
    <div class="shorts-container" id="shortsContainer"></div>
    <div class="short-nav">
      <button onclick="prevShort()">‚¨ÜÔ∏è</button>
      <button onclick="nextShort()">‚¨áÔ∏è</button>
    </div>
  </div>

  <div class="settings-modal" id="settingsModal" onclick="closeSettings(event)">
    <div class="settings-box" onclick="event.stopPropagation()">
      <div class="settings-title">Settings</div>
      <div class="setting-row">
        <span class="setting-label">Dark Mode</span>
        <div class="toggle" id="themeToggle" onclick="toggleTheme()"></div>
      </div>
      <div class="setting-row">
        <span class="setting-label">Color</span>
        <div class="setting-options" id="accentOptions"></div>
      </div>
      <div class="setting-row">
        <span class="setting-label">Reset Recommendations</span>
        <button class="clear-btn" onclick="resetPrefs()" style="font-size:13px">Reset</button>
      </div>
    </div>
  </div>

  <div class="share-modal" id="shareModal" onclick="closeShare(event)">
    <div class="share-box" onclick="event.stopPropagation()">
      <div class="share-title">Share</div>
      <div class="share-url" id="shareUrl"></div>
      <button class="copy-btn" onclick="copyLink()">üìã Copy Link</button>
      <br><button class="close-share" onclick="closeShare()">Close</button>
    </div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
const API='AIzaSyAqVubsd_VmUB2E3DIi99Yw5VfInwKNBac';
const defaultCats=['gaming','music','sports','news','comedy','tech','cooking','travel','fitness','science'];
const accents=['#ff3b30','#007aff','#af52de','#34c759','#ff9500'];
const speeds=[0.5,0.75,1,1.25,1.5,2];

let vids=[],shorts=[],nextPage='',currentQuery='',isLoading=false,currentIdx=0,ytPlayer=null,apiReady=false;
let isLoop=false,isShuffle=false,speedIdx=2,currentView='home';
let favorites=JSON.parse(localStorage.getItem('vs_fav')||'[]');
let watchLater=JSON.parse(localStorage.getItem('vs_later')||'[]');
let history=JSON.parse(localStorage.getItem('vs_history')||'[]');
let settings=JSON.parse(localStorage.getItem('vs_settings')||'{"theme":"dark","accent":"#ff3b30"}');

// PERSONALIZATION - track user interests
let prefs=JSON.parse(localStorage.getItem('vs_prefs')||'{"topics":{},"channels":{}}');

function save(){
  localStorage.setItem('vs_fav',JSON.stringify(favorites));
  localStorage.setItem('vs_later',JSON.stringify(watchLater));
  localStorage.setItem('vs_history',JSON.stringify(history.slice(0,100)));
  localStorage.setItem('vs_settings',JSON.stringify(settings));
  localStorage.setItem('vs_prefs',JSON.stringify(prefs));
}

// Learn from what user watches
function learnFromVideo(v){
  // Extract keywords from title
  const words=v.title.toLowerCase().replace(/[^a-z0-9\s]/g,'').split(' ').filter(w=>w.length>3);
  words.forEach(w=>{prefs.topics[w]=(prefs.topics[w]||0)+1});
  // Track channel
  if(v.channel){prefs.channels[v.channel]=(prefs.channels[v.channel]||0)+1}
  save();
}

// Get personalized search terms based on interests
function getPersonalizedQueries(){
  const topTopics=Object.entries(prefs.topics).sort((a,b)=>b[1]-a[1]).slice(0,5).map(t=>t[0]);
  const topChannels=Object.entries(prefs.channels).sort((a,b)=>b[1]-a[1]).slice(0,3).map(c=>c[0]);
  
  if(topTopics.length===0)return defaultCats.slice(0,3);
  
  // Mix topics and add some variety
  const queries=[...topTopics.slice(0,3)];
  if(topChannels.length>0)queries.push(topChannels[0]);
  
  // Add a random default for discovery
  queries.push(defaultCats[Math.floor(Math.random()*defaultCats.length)]);
  
  return queries;
}

function resetPrefs(){
  prefs={topics:{},channels:{}};
  save();
  alert('Recommendations reset!');
  goHome();
}

function applySettings(){
  document.body.setAttribute('data-theme',settings.theme);
  document.documentElement.style.setProperty('--accent',settings.accent);
  document.getElementById('themeToggle')?.classList.toggle('on',settings.theme==='light');
  renderAccentOptions();
}

function renderAccentOptions(){
  const el=document.getElementById('accentOptions');
  if(el)el.innerHTML=accents.map(c=>`<div class="setting-opt ${settings.accent===c?'active':''}" style="background:${c}" onclick="setAccent('${c}')"></div>`).join('');
}

function toggleTheme(){settings.theme=settings.theme==='dark'?'light':'dark';applySettings();save()}
function setAccent(c){settings.accent=c;applySettings();save()}
function openSettings(){document.getElementById('settingsModal').classList.add('show')}
function closeSettings(e){if(!e||e.target.id==='settingsModal')document.getElementById('settingsModal').classList.remove('show')}

function onYouTubeIframeAPIReady(){apiReady=true}

const fmtViews=n=>{if(!n)return'0';n=parseInt(n);return n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'K':n+''};
const fmtDur=d=>{if(!d)return'0:00';const m=d.match(/PT(\d+H)?(\d+M)?(\d+S)?/);if(!m)return'0:00';const h=parseInt(m[1])||0,min=parseInt(m[2])||0,s=parseInt(m[3])||0;return h?`${h}:${String(min).padStart(2,'0')}:${String(s).padStart(2,'0')}`:`${min}:${String(s).padStart(2,'0')}`};
const fmtDate=d=>{if(!d)return'';const days=Math.floor((new Date()-new Date(d))/864e5);return days>=365?Math.floor(days/365)+'y ago':days>=30?Math.floor(days/30)+'mo ago':days>=7?Math.floor(days/7)+'w ago':days>0?days+'d ago':'Today'};

function isFav(id){return favorites.some(v=>v.id===id)}
function isLater(id){return watchLater.some(v=>v.id===id)}
function setNav(id){document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));document.getElementById(id)?.classList.add('active')}

// HOME with personalized feed
function goHome(){
  currentView='home';setNav('navHome');
  const queries=getPersonalizedQueries();
  const isPersonalized=Object.keys(prefs.topics).length>5;
  
  document.getElementById('mainContent').innerHTML=`
    ${isPersonalized?'<div class="for-you">‚ú® Personalized for you based on what you watch</div>':''}
    <div class="tabs" id="cats"></div>
    <div class="grid" id="grid"></div>
    <div class="loader" id="loader"><span class="spinner"></span></div>`;
  
  renderCats();
  fetchPersonalizedFeed();
}

function renderCats(){
  const cats=[{q:'',name:'For You'},{q:'music',name:'Music'},{q:'gaming',name:'Gaming'},{q:'news',name:'News'},{q:'sports',name:'Sports'},{q:'comedy',name:'Comedy'}];
  document.getElementById('cats').innerHTML=cats.map(c=>`<button class="tab ${currentQuery===c.q?'active':''}" onclick="selCat('${c.q}')">${c.name}</button>`).join('');
}

async function fetchPersonalizedFeed(){
  const g=document.getElementById('grid');
  g.innerHTML='<div class="empty"><span class="spinner"></span></div>';
  
  const queries=getPersonalizedQueries();
  let allVids=[];
  
  try{
    // Fetch from multiple personalized queries in parallel (FASTER!)
    const promises=queries.slice(0,3).map(q=>
      fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=8&q=${encodeURIComponent(q)}&type=video&key=${API}`)
        .then(r=>r.json())
        .catch(()=>({items:[]}))
    );
    
    const results=await Promise.all(promises);
    const allItems=results.flatMap(r=>r.items||[]);
    
    // Get unique video IDs
    const ids=[...new Set(allItems.map(i=>i.id?.videoId).filter(Boolean))].join(',');
    if(!ids){g.innerHTML='<div class="empty">No videos found</div>';return}
    
    const dr=await(await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails,statistics&id=${ids}&key=${API}`)).json();
    
    // Get channel avatars
    const cids=[...new Set(dr.items.map(i=>i.snippet.channelId))].join(',');
    const cr=await(await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${cids}&key=${API}`)).json();
    const avatars={};cr.items?.forEach(c=>avatars[c.id]=c.snippet.thumbnails.default.url);
    
    vids=dr.items.map(v=>({
      id:v.id,title:v.snippet.title,channel:v.snippet.channelTitle,
      avatar:avatars[v.snippet.channelId]||'',
      views:fmtViews(v.statistics?.viewCount),
      time:fmtDate(v.snippet.publishedAt),
      dur:fmtDur(v.contentDetails?.duration),
      thumb:v.snippet.thumbnails.high?.url||v.snippet.thumbnails.medium?.url,
      embed:true
    }));
    
    // Shuffle for variety
    vids.sort(()=>Math.random()-0.5);
    renderVids();
  }catch(e){
    g.innerHTML=`<div class="empty">Error loading videos</div>`;
  }
}

async function fetchVids(q='',loadMore=false){
  if(isLoading)return;isLoading=true;
  if(!loadMore){vids=[];nextPage='';currentQuery=q}
  const g=document.getElementById('grid');
  const loader=document.getElementById('loader');
  if(!loadMore&&g)g.innerHTML='<div class="empty"><span class="spinner"></span></div>';
  if(loader)loader.classList.toggle('active',loadMore);
  
  try{
    let url=`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=20&q=${encodeURIComponent(q||'trending')}&type=video&key=${API}`;
    if(loadMore&&nextPage)url+=`&pageToken=${nextPage}`;
    
    const sr=await(await fetch(url)).json();
    if(sr.error)throw new Error(sr.error.message);
    nextPage=sr.nextPageToken||'';
    
    const ids=sr.items.map(i=>i.id.videoId).join(',');
    const dr=await(await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails,statistics&id=${ids}&key=${API}`)).json();
    const cids=[...new Set(dr.items.map(i=>i.snippet.channelId))].join(',');
    const cr=await(await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet&id=${cids}&key=${API}`)).json();
    const avatars={};cr.items?.forEach(c=>avatars[c.id]=c.snippet.thumbnails.default.url);
    
    const newVids=dr.items.map(v=>({
      id:v.id,title:v.snippet.title,channel:v.snippet.channelTitle,
      avatar:avatars[v.snippet.channelId]||'',
      views:fmtViews(v.statistics?.viewCount),
      time:fmtDate(v.snippet.publishedAt),
      dur:fmtDur(v.contentDetails?.duration),
      thumb:v.snippet.thumbnails.high?.url||v.snippet.thumbnails.medium?.url,
      embed:true
    }));
    
    vids=loadMore?[...vids,...newVids]:newVids;
    renderVids();
  }catch(e){if(g)g.innerHTML=`<div class="empty">Error: ${e.message}</div>`}
  if(loader)loader.classList.remove('active');
  isLoading=false;
}

function renderVids(){
  const g=document.getElementById('grid');if(!g)return;
  if(!vids.length){g.innerHTML='<div class="empty">No videos</div>';return}
  g.innerHTML=vids.map((v,i)=>`
    <div class="card" onclick="play(${i})">
      <div class="thumb-wrap">
        <img class="thumb" src="${v.thumb}" loading="lazy">
        <span class="dur">${v.dur}</span>
        <div class="card-actions">
          <button class="card-action ${isFav(v.id)?'active':''}" onclick="event.stopPropagation();quickFav(${i})">${isFav(v.id)?'‚ù§Ô∏è':'ü§ç'}</button>
          <button class="card-action" onclick="event.stopPropagation();quickLater(${i})">${isLater(v.id)?'‚úì':'‚è∞'}</button>
        </div>
      </div>
      <div class="info">
        ${v.avatar?`<div class="avatar"><img src="${v.avatar}"></div>`:`<div class="avatar">${(v.channel||'?')[0]}</div>`}
        <div class="meta">
          <div class="title">${v.title}</div>
          <div class="stats">${v.views} ‚Ä¢ ${v.time}</div>
        </div>
      </div>
    </div>`).join('');
}

function quickFav(i){const v=vids[i];if(isFav(v.id))favorites=favorites.filter(f=>f.id!==v.id);else favorites.unshift(v);save();renderVids()}
function quickLater(i){const v=vids[i];if(isLater(v.id))watchLater=watchLater.filter(f=>f.id!==v.id);else watchLater.unshift(v);save();renderVids()}

function selCat(q){
  currentQuery=q;
  renderCats();
  if(q==='')fetchPersonalizedFeed();
  else fetchVids(q);
}

function search(e){
  e.preventDefault();
  const q=document.getElementById('q').value.trim();
  if(q){currentView='home';goHome();setTimeout(()=>fetchVids(q),100)}
}

// SHORTS - personalized
let currentShortIdx=0;
async function showShorts(){
  currentView='shorts';setNav('navShorts');
  document.getElementById('bottomNav').style.display='none';
  document.getElementById('shortsViewer').classList.add('active');
  document.getElementById('shortsContainer').innerHTML='<div class="short-item"><span class="spinner" style="position:absolute;top:50%;left:50%"></span></div>';
  
  // Get personalized shorts query
  const queries=getPersonalizedQueries();
  const shortQuery=queries[0]+' shorts';
  
  try{
    const sr=await(await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&maxResults=15&q=${encodeURIComponent(shortQuery)}&type=video&videoDuration=short&key=${API}`)).json();
    const ids=sr.items.map(i=>i.id.videoId).join(',');
    const dr=await(await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=${ids}&key=${API}`)).json();
    
    shorts=dr.items.map(v=>({
      id:v.id,
      title:v.snippet.title,
      channel:v.snippet.channelTitle,
      thumb:v.snippet.thumbnails.high?.url,
      likes:fmtViews(v.statistics?.likeCount)
    }));
    
    currentShortIdx=0;
    renderShorts();
  }catch(e){
    document.getElementById('shortsContainer').innerHTML='<div class="short-item" style="color:#fff;display:flex;align-items:center;justify-content:center">Error loading</div>';
  }
}

function renderShorts(){
  const container=document.getElementById('shortsContainer');
  container.innerHTML=shorts.map((s,i)=>`
    <div class="short-item" data-idx="${i}">
      <div class="short-video">
        <iframe src="https://www.youtube.com/embed/${s.id}?autoplay=${i===0?1:0}&loop=1&playlist=${s.id}&controls=0&playsinline=1&mute=${i===0?0:1}" allow="autoplay" id="shortFrame${i}"></iframe>
        <div class="short-tap" onclick="tapShort(${i})"></div>
        <div class="short-overlay">
          <div class="short-title">${s.title}</div>
          <div class="short-channel">@${s.channel}</div>
        </div>
        <div class="short-actions">
          <button class="short-action ${isFav(s.id)?'active':''}" onclick="toggleShortFav(${i})">
            <div class="short-action-icon">${isFav(s.id)?'‚ù§Ô∏è':'ü§ç'}</div>
            <span>${s.likes||'Like'}</span>
          </button>
          <button class="short-action" onclick="shareShort(${i})">
            <div class="short-action-icon">‚ÜóÔ∏è</div>
            <span>Share</span>
          </button>
        </div>
      </div>
    </div>
  `).join('');
  
  // Observe scroll
  const observer=new IntersectionObserver((entries)=>{
    entries.forEach(entry=>{
      const idx=parseInt(entry.target.dataset.idx);
      const frame=document.getElementById(`shortFrame${idx}`);
      if(entry.isIntersecting&&entry.intersectionRatio>0.5){
        currentShortIdx=idx;
        if(frame)frame.src=frame.src.replace('autoplay=0','autoplay=1').replace('mute=1','mute=0');
        learnFromVideo(shorts[idx]); // Learn from shorts too
      }else{
        if(frame&&frame.src.includes('autoplay=1'))frame.src=frame.src.replace('autoplay=1','autoplay=0').replace('mute=0','mute=1');
      }
    });
  },{threshold:0.5});
  
  container.querySelectorAll('.short-item').forEach(el=>observer.observe(el));
}

function tapShort(i){
  const frame=document.getElementById(`shortFrame${i}`);
  // Toggle play/pause by reloading with opposite autoplay
  if(frame.src.includes('autoplay=1'))frame.src=frame.src.replace('autoplay=1','autoplay=0');
  else frame.src=frame.src.replace('autoplay=0','autoplay=1');
}

function nextShort(){
  if(currentShortIdx<shorts.length-1){
    currentShortIdx++;
    document.querySelectorAll('.short-item')[currentShortIdx]?.scrollIntoView({behavior:'smooth'});
  }
}

function prevShort(){
  if(currentShortIdx>0){
    currentShortIdx--;
    document.querySelectorAll('.short-item')[currentShortIdx]?.scrollIntoView({behavior:'smooth'});
  }
}

function toggleShortFav(i){
  const s=shorts[i];
  if(isFav(s.id))favorites=favorites.filter(f=>f.id!==s.id);
  else favorites.unshift({id:s.id,title:s.title,thumb:s.thumb,channel:s.channel,dur:'0:60'});
  save();renderShorts();
}

function shareShort(i){
  document.getElementById('shareUrl').textContent='https://youtube.com/shorts/'+shorts[i].id;
  document.getElementById('shareModal').classList.add('show');
}

function closeShorts(){
  document.getElementById('shortsViewer').classList.remove('active');
  document.getElementById('bottomNav').style.display='flex';
  currentView='home';setNav('navHome');
}

function showFavorites(){
  currentView='favorites';setNav('navFav');
  document.getElementById('mainContent').innerHTML=`<div class="section-title">‚ù§Ô∏è Favorites <button class="clear-btn" onclick="clearFav()">Clear</button></div><div class="grid" id="grid"></div>`;
  vids=favorites;renderVids();
  if(!vids.length)document.getElementById('grid').innerHTML='<div class="empty">No favorites yet</div>';
}

function showWatchLater(){
  currentView='later';setNav('navLater');
  document.getElementById('mainContent').innerHTML=`<div class="section-title">‚è∞ Watch Later <button class="clear-btn" onclick="clearLater()">Clear</button></div><div class="grid" id="grid"></div>`;
  vids=watchLater;renderVids();
  if(!vids.length)document.getElementById('grid').innerHTML='<div class="empty">No videos saved</div>';
}

function showHistory(){
  currentView='history';setNav('navHistory');
  document.getElementById('mainContent').innerHTML=`<div class="section-title">üïê History <button class="clear-btn" onclick="clearHistory()">Clear</button></div><div class="grid" id="grid"></div>`;
  vids=history;renderVids();
  if(!vids.length)document.getElementById('grid').innerHTML='<div class="empty">No history</div>';
}

function clearFav(){favorites=[];save();showFavorites()}
function clearLater(){watchLater=[];save();showWatchLater()}
function clearHistory(){history=[];save();showHistory()}

window.addEventListener('scroll',()=>{
  if(isLoading||!nextPage||currentView!=='home')return;
  if(window.innerHeight+window.scrollY>=document.body.offsetHeight-800)fetchVids(currentQuery,true);
});

function onPlayerStateChange(event){
  if(event.data===YT.PlayerState.ENDED){
    if(isLoop&&ytPlayer)ytPlayer.seekTo(0);
    else playNext();
  }
}

function updatePlayerBtns(){
  const v=vids[currentIdx];if(!v)return;
  document.getElementById('favBtn').className='pl-btn'+(isFav(v.id)?' active':'');
  document.getElementById('favBtn').innerHTML=(isFav(v.id)?'‚ù§Ô∏è':'ü§ç')+' Like';
  document.getElementById('laterBtn').className='pl-btn'+(isLater(v.id)?' active':'');
  document.getElementById('loopBtn').classList.toggle('active',isLoop);
  document.getElementById('shuffleBtn').classList.toggle('active',isShuffle);
  document.getElementById('speedBtn').textContent=speeds[speedIdx]+'x';
}

function play(i){
  currentIdx=i;const v=vids[i];if(!v)return;
  
  // Learn from this video
  learnFromVideo(v);
  
  // Add to history
  if(!history.some(h=>h.id===v.id)){
    history.unshift(v);
    history=history.slice(0,100);
    save();
  }
  
  document.getElementById('modalTitle').textContent=v.title;
  document.getElementById('pTitle').textContent=v.title;
  document.getElementById('pChannel').textContent=v.channel||'';
  document.getElementById('pStats').textContent=(v.views?v.views+' ‚Ä¢ ':'')+v.time;
  document.getElementById('pAvatarWrap').innerHTML=v.avatar?`<img class="player-avatar" src="${v.avatar}">`:`<div class="avatar">${(v.channel||'?')[0]}</div>`;
  updatePlayerBtns();
  
  const nextIdx=(i+1)%vids.length;const nextVid=vids[nextIdx];
  if(nextVid){
    document.getElementById('nextThumb').src=nextVid.thumb;
    document.getElementById('nextTitle').textContent=nextVid.title;
    document.getElementById('nextChannel').textContent=nextVid.channel||'';
  }
  
  const w=document.getElementById('playerWrap');
  if(apiReady){
    w.innerHTML='<div id="ytplayer"></div>';
    if(ytPlayer){ytPlayer.destroy();ytPlayer=null}
    ytPlayer=new YT.Player('ytplayer',{videoId:v.id,playerVars:{autoplay:1,controls:1,modestbranding:1,rel:0,iv_load_policy:3,playsinline:1},events:{onStateChange:onPlayerStateChange,onReady:()=>{if(speeds[speedIdx]!==1)ytPlayer.setPlaybackRate(speeds[speedIdx])}}});
  }else{
    w.innerHTML=`<iframe src="https://www.youtube.com/embed/${v.id}?autoplay=1&rel=0&playsinline=1" style="width:100%;height:100%;border:none" allow="autoplay"></iframe>`;
  }
  
  document.getElementById('miniPlayer').classList.remove('active');
  document.getElementById('modal').classList.add('active');
}

function playNext(){if(isShuffle)play(Math.floor(Math.random()*vids.length));else play((currentIdx+1)%vids.length)}
function playPrev(){play((currentIdx-1+vids.length)%vids.length)}
function toggleLoop(){isLoop=!isLoop;updatePlayerBtns()}
function toggleShuffle(){isShuffle=!isShuffle;updatePlayerBtns()}
function cycleSpeed(){speedIdx=(speedIdx+1)%speeds.length;if(ytPlayer)ytPlayer.setPlaybackRate(speeds[speedIdx]);updatePlayerBtns()}

function toggleFav(){const v=vids[currentIdx];if(isFav(v.id))favorites=favorites.filter(f=>f.id!==v.id);else favorites.unshift(v);save();updatePlayerBtns()}
function toggleLater(){const v=vids[currentIdx];if(isLater(v.id))watchLater=watchLater.filter(f=>f.id!==v.id);else watchLater.unshift(v);save();updatePlayerBtns()}

function minimizePlayer(){
  const v=vids[currentIdx];
  document.getElementById('miniThumb').src=v.thumb;
  document.getElementById('miniTitle').textContent=v.title;
  document.getElementById('modal').classList.remove('active');
  document.getElementById('miniPlayer').classList.add('active');
}

function expandPlayer(){document.getElementById('miniPlayer').classList.remove('active');document.getElementById('modal').classList.add('active')}
function toggleMiniPlay(){if(ytPlayer){ytPlayer.getPlayerState()===1?ytPlayer.pauseVideo():ytPlayer.playVideo()}}
function closeMini(){document.getElementById('miniPlayer').classList.remove('active');if(ytPlayer){ytPlayer.destroy();ytPlayer=null}}
function closeModal(){document.getElementById('modal').classList.remove('active');if(ytPlayer){ytPlayer.destroy();ytPlayer=null}}

function shareVideo(){
  document.getElementById('shareUrl').textContent='https://youtu.be/'+vids[currentIdx].id;
  document.getElementById('shareModal').classList.add('show');
}
function closeShare(e){if(!e||e.target.id==='shareModal')document.getElementById('shareModal').classList.remove('show')}
function copyLink(){navigator.clipboard.writeText(document.getElementById('shareUrl').textContent);document.querySelector('.copy-btn').textContent='‚úì Copied!';setTimeout(()=>document.querySelector('.copy-btn').textContent='üìã Copy Link',1500)}

document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeModal();closeShorts()}});

applySettings();
goHome();
</script>
</body>
</html>
